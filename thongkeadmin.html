<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Th·ªëng K√™</title>
  </head>
  <link rel="stylesheet" href="/assets/css/thongkeadmin.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <body>
    <header class="main-header">
      <div class="logo">
        <a href="noidung.html">Website qu·∫£n l√Ω b√†i vi·∫øt</a>
      </div>

      <button class="theme-toggle" aria-label="Toggle light and dark mode">
        ‚òÄÔ∏è
      </button>

      <button class="menu-toggle" aria-label="Toggle navigation">
        &#9776;
      </button>

      <nav class="main-nav">
        <ul class="nav-list">
          <li><a href="noidung.html" class="nav-item">üè† Trang ch·ªß</a></li>
          <li>
            <a href="thongkeuser.html" class="nav-item user-stat-btn"
              >üìä Th·ªëng k√™ c√° nh√¢n</a
            >
          </li>

          <li class="admin-only" style="display: none">
            <a href="quanly.html" class="nav-item">‚öôÔ∏è Qu·∫£n l√Ω Admin</a>
          </li>
          <li class="admin-only" style="display: none">
            <a href="thongkeadmin.html" class="nav-item">üìà Th·ªëng k√™ chung</a>
          </li>

          <li>
            <a href="#" class="nav-item auth-btn logout-link">üö™ ƒêƒÉng xu·∫•t</a>
          </li>
          <li>
            <a
              href="login.html"
              class="nav-item auth-btn login-link logout"
              style="display: none"
              >üîë ƒêƒÉng nh·∫≠p</a
            >
          </li>
        </ul>
      </nav>
    </header>
    <p class="hello">Xin ch√†o, admin!</p>
    <div class="container">
      <div class="cards">
        <h2>üë§T·ªïng user</h2>
        <p>5</p>
        <p>S·ªë t√†i kho·∫£n c√≥ role l√† user</p>
      </div>
      <div class="cards">
        <h2>üìùT·ªïng b√†i vi·∫øt</h2>
        <p>4</p>
        <p>S·ªë b√†i vi·∫øt public v√† private</p>
      </div>
      <div class="cards">
        <h2>üåêB√†i vi·∫øt c√¥ng khai (public)</h2>
        <p>6</p>
        <p>B√†i vi·∫øt m√† m·ªçi ng∆∞·ªùi c√≥ th·ªÉ xem</p>
      </div>
      <div class="cards">
        <h2>‚ù§Ô∏èL∆∞·ª£t th√≠ch</h2>
        <p>5</p>
        <p>T·ªïng s·ªë likes to√†n h·ªá th·ªëng</p>
      </div>
      <div class="cards">
        <h2>üí¨B√¨nh lu·∫≠n</h2>
        <p>6</p>
        <p>T·ªïng s·ªë comments to√†n h·ªá th·ªëng</p>
      </div>
    </div>
  </body>
  <script src="/assets/js/layout.js"></script>
  <script>

    const loggedInUser = localStorage.getItem("loggedInUser");
    const userRole = localStorage.getItem("loggedInUserRole");

    const helloElement = document.querySelector(".hello");
    const btnLogout = document.querySelector(".logout");
    const btnAdminPage = document.querySelector(".stats");
    const cards = document.querySelectorAll(".cards");

    const getAccounts = () =>
      JSON.parse(localStorage.getItem("accounts")) || [];
    const getPosts = () => JSON.parse(localStorage.getItem("posts")) || [];

    // 1. KI·ªÇM TRA QUY·ªÄN ADMIN

    if (userRole !== "admin" || !loggedInUser) {
      alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang th·ªëng k√™ n√†y.");
      window.location.href = "noidung.html";
    } else {
      helloElement.textContent = `Xin ch√†o, ${loggedInUser} (${userRole})!`;
    }

    // 2. H√ÄM T√çNH TO√ÅN V√Ä TH·ªêNG K√ä

    function calculateStatistics() {
      const accounts = getAccounts();
      const posts = getPosts();

      // --- 1. Th·ªëng k√™ User ---
      const totalUsers = accounts.length;
      const totalUserRole = accounts.filter(
        (acc) => acc.role === "user"
      ).length;

      // --- 2. Th·ªëng k√™ B√†i vi·∫øt ---
      const totalPosts = posts.length;
      const publicPosts = posts.filter(
        (post) => post.visibility === "C√¥ng khai"
      ).length;

      // T√≠nh t·ªïng Likes
      const totalLikes = posts.reduce(
        (sum, post) => sum + (post.likes || 0),
        0
      );

      // T√≠nh t·ªïng Comments
      const totalComments = posts.reduce(
        (sum, post) => sum + (post.comments ? post.comments.length : 0),
        0
      );

      // Tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a t·∫•t c·∫£ k·∫øt qu·∫£
      return {
        totalUsers,
        totalUserRole,
        totalPosts,
        publicPosts,
        totalLikes,
        totalComments,
      };
    }

    // 3. HI·ªÇN TH·ªä K·∫æT QU·∫¢ RA GIAO DI·ªÜN

    function displayStats() {
      const stats = calculateStatistics();

      // 1. T·ªïng user
      cards[0].querySelector("p:nth-of-type(1)").textContent = stats.totalUsers;
      cards[0].querySelector(
        "p:nth-of-type(2)"
      ).textContent = `S·ªë t√†i kho·∫£n c√≥ role l√† user: ${stats.totalUserRole}`;

      // 2. T·ªïng b√†i vi·∫øt
      cards[1].querySelector("p:nth-of-type(1)").textContent = stats.totalPosts;
      cards[1].querySelector(
        "p:nth-of-type(2)"
      ).textContent = `Bao g·ªìm c·∫£ b√†i c√¥ng khai v√† ri√™ng t∆∞`;

      // 3. B√†i vi·∫øt c√¥ng khai
      cards[2].querySelector("p:nth-of-type(1)").textContent =
        stats.publicPosts;
      cards[2].querySelector(
        "p:nth-of-type(2)"
      ).textContent = `B√†i vi·∫øt m√† m·ªçi ng∆∞·ªùi c√≥ th·ªÉ xem`;

      // 4. T·ªïng L∆∞·ª£t th√≠ch
      cards[3].querySelector("p:nth-of-type(1)").textContent = stats.totalLikes;
      cards[3].querySelector(
        "p:nth-of-type(2)"
      ).textContent = `T·ªïng s·ªë likes to√†n h·ªá th·ªëng`;

      // 5. T·ªïng B√¨nh lu·∫≠n
      cards[4].querySelector("p:nth-of-type(1)").textContent =
        stats.totalComments;
      cards[4].querySelector(
        "p:nth-of-type(2)"
      ).textContent = `T·ªïng s·ªë comments to√†n h·ªá th·ªëng`;
    }

    displayStats();
  </script>
</html>
