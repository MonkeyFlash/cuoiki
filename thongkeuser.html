<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thá»‘ng KÃª</title>
  </head>
  <link rel="stylesheet" href="/assets/css/thongkeuser.css" />
  <link rel="stylesheet" href="/assets/css/layout.css" />
  <body>
    <header class="main-header">
      <div class="logo">
        <a href="noidung.html">Website quáº£n lÃ½ bÃ i viáº¿t</a>
      </div>

      <button class="theme-toggle" aria-label="Toggle light and dark mode">
        â˜€ï¸
      </button>

      <button class="menu-toggle" aria-label="Toggle navigation">
        &#9776;
      </button>

      <nav class="main-nav">
        <ul class="nav-list">
          <li><a href="noidung.html" class="nav-item">ğŸ Trang chá»§</a></li>
          <li>
            <a href="thongkeuser.html" class="nav-item user-stat-btn">ğŸ“ˆThá»‘ng kÃª cÃ¡ nhÃ¢n</a>
          </li>

          <li class="admin-only" style="display: none">
            <a href="quanly.html" class="nav-item">Quáº£n lÃ½ Admin</a>
          </li>
          <li class="admin-only" style="display: none">
            <a href="thongkeadmin.html" class="nav-item">Thá»‘ng kÃª chung</a>
          </li>

          <li>
            <a href="#" class="nav-item auth-btn logout-link">ğŸšªÄÄƒng xuáº¥t</a>
          </li>
          <li>
            <a
              href="login.html"
              class="nav-item auth-btn login-link logout"
              style="display: none"
              >ÄÄƒng nháº­p</a
            >
          </li>
        </ul>
      </nav>
    </header>
    <p class="hello">Xin chÃ o, user!</p>
    <div class="container">
      <div class="cards">
        <h2>ğŸ“Tá»•ng sá»‘ bÃ i viáº¿t</h2>
        <p>5</p>
        <p>Sá»‘ bÃ i viáº¿t public vÃ  private</p>
      </div>
      <div class="cards">
        <h2>ğŸŒTá»•ng bÃ i viáº¿t public</h2>
        <p>4</p>
      </div>
      <div class="cards">
        <h2>ğŸ•µï¸Tá»•ng bÃ i viáº¿t private</h2>
        <p>6</p>
      </div>
      <div class="cards">
        <h2>â¤ï¸LÆ°á»£t thÃ­ch nháº­n</h2>
        <p>5</p>
      </div>
      <div class="cards">
        <h2>ğŸ’¬BÃ¬nh luáº­n nháº­n</h2>
        <p>6</p>
      </div>
      <div class="cards">
        <h2>Theo chá»§ Ä‘á»</h2>
        <ul>
          <li>Chá»§ Ä‘á» 1: 2 bÃ i viáº¿t</li>
          <li>Chá»§ Ä‘á» 2: 3 bÃ i viáº¿t</li>
          <li>Chá»§ Ä‘á» 3: 1 bÃ i viáº¿t</li>
        </ul>
      </div>
    </div>
  </body>
  <script src="/assets/js/layout.js"></script>
  <script>
    const loggedInUser = localStorage.getItem("loggedInUser");
    const userRole = localStorage.getItem("loggedInUserRole");

    const helloElement = document.querySelector(".hello");
    const btnLogout = document.querySelector(".logout");
    const btnUserPage = document.querySelector(".stats");
    const cards = document.querySelectorAll(".cards");

    const getPosts = () => JSON.parse(localStorage.getItem("posts")) || [];

    // 1. KIá»‚M TRA ÄÄ‚NG NHáº¬P

    if (!loggedInUser) {
      alert("Báº¡n chÆ°a Ä‘Äƒng nháº­p. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.");
      window.location.href = "login.html";
    } else {
      helloElement.textContent = `Xin chÃ o, ${loggedInUser}!`;
    }

    // 2. HÃ€M TÃNH TOÃN VÃ€ THá»NG KÃŠ CÃ NHÃ‚N

    function calculateUserStatistics() {
      const allPosts = getPosts();

      // Lá»c ra CHá»ˆ cÃ¡c bÃ i viáº¿t cá»§a ngÆ°á»i dÃ¹ng hiá»‡n táº¡i
      const userPosts = allPosts.filter((post) => post.author === loggedInUser);

      // --- 1. Tá»•ng sá»‘ bÃ i viáº¿t ---
      const totalPosts = userPosts.length;

      // --- 2. BÃ i viáº¿t CÃ´ng khai vÃ  RiÃªng tÆ° ---
      const publicPosts = userPosts.filter(
        (post) => post.visibility === "CÃ´ng khai"
      ).length;
      const privatePosts = userPosts.filter(
        (post) => post.visibility === "RiÃªng tÆ°"
      ).length;

      // --- 3. LÆ°á»£t tÆ°Æ¡ng tÃ¡c nháº­n Ä‘Æ°á»£c ---
      const totalLikesReceived = userPosts.reduce(
        (sum, post) => sum + (post.likes || 0),
        0
      );
      const totalCommentsReceived = userPosts.reduce(
        (sum, post) => sum + (post.comments ? post.comments.length : 0),
        0
      );

      // --- 4. Thá»‘ng kÃª theo Chá»§ Ä‘á» ---
      const topicStats = userPosts.reduce((stats, post) => {
        const topic = post.topic || "KhÃ´ng chá»§ Ä‘á»";
        stats[topic] = (stats[topic] || 0) + 1;
        return stats;
      }, {});

      return {
        totalPosts,
        publicPosts,
        privatePosts,
        totalLikesReceived,
        totalCommentsReceived,
        topicStats,
      };
    }

    // 3. HIá»‚N THá»Š Káº¾T QUáº¢ RA GIAO DIá»†N

    function displayUserStats() {
      const stats = calculateUserStatistics();

      // 1. Tá»•ng sá»‘ bÃ i viáº¿t (public vÃ  private)
      cards[0].querySelector("p:nth-of-type(1)").textContent = stats.totalPosts;

      // 2. Tá»•ng bÃ i viáº¿t public
      cards[1].querySelector("p:nth-of-type(1)").textContent =
        stats.publicPosts;

      // 3. Tá»•ng bÃ i viáº¿t private
      cards[2].querySelector("p:nth-of-type(1)").textContent =
        stats.privatePosts;

      // 4. LÆ°á»£t thÃ­ch nháº­n
      cards[3].querySelector("p:nth-of-type(1)").textContent =
        stats.totalLikesReceived;

      // 5. BÃ¬nh luáº­n nháº­n
      cards[4].querySelector("p:nth-of-type(1)").textContent =
        stats.totalCommentsReceived;

      // 6. Theo chá»§ Ä‘á»
      const topicList = cards[5].querySelector("ul");
      topicList.innerHTML = "";

      // Duyá»‡t qua thá»‘ng kÃª chá»§ Ä‘á» vÃ  táº¡o cÃ¡c má»¥c li
      const topicsArray = Object.entries(stats.topicStats).sort(
        (a, b) => b[1] - a[1]
      );

      if (topicsArray.length === 0) {
        topicList.innerHTML = "<li>ChÆ°a cÃ³ bÃ i viáº¿t nÃ o Ä‘Æ°á»£c táº¡o.</li>";
      } else {
        topicsArray.forEach(([topicName, count]) => {
          const listItem = document.createElement("li");
          listItem.textContent = `${topicName}: ${count} bÃ i viáº¿t`;
          topicList.appendChild(listItem);
        });
      }
    }

    displayUserStats();
  </script>
</html>
